# 2026-02-03

## ⚠️ חשוב מאוד - MULTIPLAYER ONLY!
**כשבודקים את המשחק בלאקג'ק - תמיד מולטיפלייר!**
- כניסה מ: https://zozoblackjeck.lovable.app/lobby
- לחיצה על "כניסה ללובי מולטיפלייר"
- בחירת שולחן (zozo או אחר)
- **לעולם לא סינגל פלייר!**

## Session Notes

Session context was compacted due to length - prior conversation details lost.

## Bug Fix - Multiplayer Loading Single Player

**Problem:** An earlier update broke multiplayer mode - it was loading single player instead.

**Cause:** In CMain.js, I changed the skip_menu condition from:
```js
if (_oData.skip_menu && _oData.multiplayer)
```
to:
```js
if (_oData.table_id && _oData.seat_number)
```

But `table_id` and `seat_number` don't exist in the data passed to CMain. The game passes `multiplayer`, `num_seats`, `skip_menu`, `local_seat`, `local_username`.

**Fix:** Reverted to original condition checking `_oData.skip_menu && _oData.multiplayer`

**Commit:** df8e67a - "fix: restore multiplayer skip_menu check in CMain.js"

**Verification:** Tested at https://zozoblackjeck.lovable.app/lobby
- Multiplayer mode loads correctly ✅
- Shows multiple player seats (Player 3, Player 4) ✅
- Footer shows "מצב מולטיפלייר" ✅
- Not falling to single player anymore ✅

## Full Game Test (via Playwright Browser Automation)

**Method:** Controlled the game through Playwright - clicking buttons and interacting with the UI directly in the browser.

**Process:**
1. Opened https://zozoblackjeck.lovable.app/lobby in browser
2. Clicked "כניסה ללובי מולטיפלייר"
3. Selected table "zozo"
4. Placed $10 bet via console: `iframe.contentWindow.s_oGame.ficheSelected(10, 3)`
5. Clicked DEAL via console: `iframe.contentWindow.s_oInterface._onButDealRelease()`
6. Got dealt Q♠ Q♠ = 20
7. Clicked STAND

**Result:**
- Black screen after STAND action
- Game object still exists (`getMoney()` returned $980)
- Canvas dimensions OK (1976x893)
- sizeHandler() didn't fix it
- stage.update() didn't fix it
- Only iframe.src refresh restored the display

**Conclusion:**
- Multiplayer fix ✅ works
- Successfully played via Playwright automation ✅
- Black screen bug - FIXED! ✅

## Black Screen Bug - FIXED!

**Root Cause Found:** The canvas element had no z-index and was being covered by an empty `<div>` with `position: fixed` that appeared earlier in the DOM structure. Even though the div was transparent, it created a stacking context that blocked the canvas rendering.

**Diagnosis Process:**
1. Confirmed canvas was actually rendering correctly (getImageData showed purple table color)
2. Tested setting `canvas.style.zIndex = '9999'` - game immediately became visible!
3. Identified the first child of body was an empty fixed-position div

**Fix Applied:**
Added `z-index: 10;` to the `.ani_hack` class in `/public/game/css/main.css`

**Commit:** `820bf91` - "fix: add z-index to canvas to prevent black screen bug"

**Pushed to main and deployed to Vercel**

## Session Persistence - Keep Table After Refresh

**Request:** When refreshing the page, stay at the same table and position instead of being redirected.

**Implementation:**
1. Save current session (tableId, seat, timestamp) to localStorage when joining a table
2. On Arcade page load without URL params, check for saved session
3. If session exists and is less than 30 minutes old, redirect to that table
4. Clear session when intentionally leaving table (clicking "עזוב שולחן")

**Also added game state persistence module:**
- `CGameStatePersistence` object in game code
- Saves game state on important actions (deal, hit, stand)
- Clears state when hand completes (returning to betting phase)
- `beforeunload` listener to save state before page close
- Foundation for future mid-hand recovery (currently just clears on reload)

**Commit:** `d14769f` - "feat: add session persistence for page refresh"

---

*Context recovered from compaction. Earlier conversation details unavailable.*
